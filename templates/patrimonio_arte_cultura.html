{% extends "base.html" %}

{% block title %}Patrimonio, arte y cultura{% endblock %}

{% block head %}
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Estilos personalizados -->
  <style>
    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #cfd8d8;
      overflow-x: hidden;
    }

    .contenido-principal {
      padding: 2rem;
      background-color: #cfd8d8;
      min-height: 100vh;
    }

    h1 {
      color: #154360;
      padding-top: 1rem;
    }

    a button,
    button {
      background-color: #154360;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
      font-size: 1rem;
    }

    a button:hover,
    button:hover {
      background-color: #0b2e4a;
    }

    #map {
      margin-top: 1.5rem;
      height: 400px;
      width: 100%;
      border-radius: 10px;
      border: 2px solid #154360;
    }

    /* Mini pestaña (panel lateral) */
    #infoPanel {
      position: fixed;
      top: 0;
      right: -520px;
      width: 500px;
      height: 100%;
      background: rgb(231, 231, 231);
      box-shadow: -3px 0 15px rgba(0,0,0,0.3);
      padding: 20px;
      overflow-y: auto;
      transition: right 0.3s ease;
      z-index: 1000;
    }

    #infoPanel.show {
      right: 0;
    }

    #infoPanel h2 {
      margin-top: 0;
      color: #154360;
    }

    #infoPanel .closeBtn {
      position: absolute;
      top: 10px;
      right: 15px;
      background: transparent; /* ← sin fondo */
      color: #154360;           /* ← color de la X (ajústalo si quieres otro) */
      border: none;             /* ← sin borde */
      border-radius: 0;         /* ← sin esquinas redondeadas */
      font-size: 24px;          /* ← tamaño de la X */
      cursor: pointer;
    }

    #infoPanel img,
    #infoPanel video,
    #infoPanel iframe {
      width: 100%;
      max-height: 300px;
      margin-top: 15px;
      border-radius: 8px;
      object-fit: contain;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="contenido-principal">
    <h1>Patrimonio, arte y cultura</h1>
    <p>
      Medellín destaca por su patrimonio, arte y cultura, con museos, esculturas de Botero y
      festivales como la Feria de las Flores.
    </p>

    <!-- Mapa interactivo -->
    <div id="map"></div>

    <!-- Panel lateral -->
    <div id="infoPanel">
      <button class="closeBtn" title="Cerrar">&times;</button>
      <div id="infoContent"></div>
    </div>

    <!-- Botón de volver -->
    <div style="margin-top: 20px;">
      <a href="{{ url_for('index') }}#seccion2">
        <button>Volver</button>
      </a>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const mapa = L.map('map').setView([6.2518, -75.5636], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(mapa);

    const CATEGORIA_PATRIMONIO_UUID = "4c96e8cc-bf91-4db6-9640-687eaf2942c0";

    const infoPanel = document.getElementById('infoPanel');
    const infoContent = document.getElementById('infoContent');
    const closeBtn = document.querySelector('.closeBtn');

    closeBtn.addEventListener('click', () => {
      infoPanel.classList.remove('show');
    });

    function renderMedia(url) {
      if (!url) return '';
      const cleanUrl = url.split('?')[0].toLowerCase();
      const ext = cleanUrl.split('.').pop();

      const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
      const videoExtensions = ['mp4', 'webm', 'ogg'];

      if (imageExtensions.includes(ext)) {
        return `<img src="${url}" alt="Imagen">`;
      } else if (videoExtensions.includes(ext)) {
        return `
          <video controls>
            <source src="${url}" type="video/${ext}">
            Tu navegador no soporta el video.
          </video>`;
      } else {
        return `<iframe src="${url}"></iframe>`;
      }
    }

    // Cargar y procesar los datos
    Promise.all([
      fetch("http://localhost:5031/api/sitio_turistico").then(res => res.json()),
      fetch("http://localhost:5031/api/sitio_multi").then(res => res.json()),
      fetch("http://localhost:5031/api/multimedia").then(res => res.json())
    ])
    .then(([sitiosRes, sitioMultiRes, multimediaRes]) => {
      const sitios = sitiosRes.datos || [];
      const sitioMulti = sitioMultiRes.datos || [];
      const multimedia = multimediaRes.datos || [];

      const sitiosFiltrados = sitios.filter(s => s.fkidcategoria_turistica === CATEGORIA_PATRIMONIO_UUID);

      if (sitiosFiltrados.length === 0) {
        alert("⚠️ No hay sitios para la categoría 'Patrimonio y Cultura'.");
        return;
      }

      sitiosFiltrados.forEach(sitio => {
        if (!sitio.latitud || !sitio.longitud) return;

        const marker = L.marker([sitio.latitud, sitio.longitud]).addTo(mapa);

        marker.on('click', () => {
          const relacion = sitioMulti.find(r => r.fkidsitio_turistico === sitio.idsitio_turistico);
          const multimediaObj = relacion ? multimedia.find(m => m.idmultimedia === relacion.fkidmultimedia) : null;
          const mediaHtml = multimediaObj ? renderMedia(multimediaObj.url) : '';

          const html = `
            <h2>${sitio.nombre}</h2>
            <p>${sitio.descripcion}</p>
            <p><strong>Dirección:</strong> ${sitio.direccion}</p>
            <p><strong>Horario:</strong> ${sitio.horario_apertura} - ${sitio.horario_cierre}</p>
            <p><strong>Tarifa:</strong> $${sitio.tarifa}</p>
            ${mediaHtml}
          `;

          infoContent.innerHTML = html;
          infoPanel.classList.add('show');
        });
      });
    })
    .catch(err => {
      console.error("❌ Error al cargar los datos:", err);
      alert("Error al cargar sitios turísticos o multimedia.");
    });
  </script>
{% endblock %}
