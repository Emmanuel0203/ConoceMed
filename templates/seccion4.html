{% extends "base.html" %}

{% block title %}Sección 4 - ConoceMed{% endblock %}

{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/seccion4.css') }}">

<section class="vista" id="seccion4">
  <div class="cara estilo-juego" id="cara">
    <div class="level-badge">NIVEL 4</div>
      <div class="declarar-contenedor">

    <!-- Animación o imagen a la izquierda -->
    <div class="declarar-animacion" id="muneco">

    </div>

    <!-- Formulario a la derecha -->
    <div class="declarar-formulario">
      <h2>DECLARA UN LUGAR</h2>
      <p>Aquí puedes recomendar un lugar que debería estar en la app.</p>

      <form id="formSugerirLugar" method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        {{ form.nombre.label }}
        {{ form.nombre(class="form-control", placeholder="Nombre del lugar *") }}

        {{ form.direccion.label }}
        {{ form.direccion(class="form-control", placeholder="Dirección *") }}

        {{ form.latitud.label }}
        {{ form.latitud(class="form-control", placeholder="Latitud *") }}

        {{ form.longitud.label }}
        {{ form.longitud(class="form-control", placeholder="Longitud *") }}

        {{ form.descripcion.label }}
        {{ form.descripcion(class="form-control", placeholder="Descripción *", rows="4") }}

        {{ form.horario_apertura.label }}
        {{ form.horario_apertura(class="form-control", placeholder="Horario de apertura *", type="time") }}

        {{ form.horario_cierre.label }}
        {{ form.horario_cierre(class="form-control", placeholder="Horario de cierre *", type="time") }}

        {{ form.tarifa.label }}
        {{ form.tarifa(class="form-control", placeholder="Tarifa *") }}

        {{ form.idLocalidad.label }}
        {{ form.idLocalidad(class="form-control") }}

        {{ form.idCategoria_Turistica.label }}
        {{ form.idCategoria_Turistica(class="form-control") }}

        <!-- Campo de archivos -->
        <label for="archivos">Sube imágenes o videos del lugar:</label>
        <input type="file" name="archivos" id="archivos" class="form-control" multiple accept="image/*,video/*">

        {{ form.submit(class="btn btn-primary", value="Enviar sugerencia") }}
      </form>

  <!-- Hidden fields to record provenance of location and confidence (for server) -->
  <input type="hidden" name="location_source" value="" />
  <input type="hidden" name="location_confidence" value="" />

  <!-- Contenedor de mensajes -->
      <div id="mensaje-resultado" class="mensaje"></div>

    </div>

  </div>

{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const container = document.getElementById("muneco");

      if (!container) {
        console.error("❌ No se encontró el contenedor #muneco");
        return;
      }

      const muneco = lottie.loadAnimation({
        container: container,
        renderer: "svg",
        loop: true,
        autoplay: true,
        path: "{{ url_for('static', filename='images/paisaa.json') }}"
      });

      muneco.addEventListener("DOMLoaded", () => {
        console.log("✅ Animación cargada completamente");
      });
    });
  </script>

  <!-- Script para enviar el formulario sin recargar -->
  <script>
    document.getElementById("formSugerirLugar").addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(this);

      const response = await fetch("{{ url_for('vistaSugerido.sugerir_lugar') }}", {
        method: "POST",
        body: formData
      });

      const data = await response.json();

      const mensaje = document.getElementById("mensaje-resultado");
      if (data.success) {
        // No mostramos el mensaje inline; usamos el flash overlay en su lugar
        this.reset();
        if (typeof showFlash === 'function') {
          showFlash('LUGAR SUGERIDO\n¡Gracias!');
        }
        // opcional: limpiar cualquier texto previo en el contenedor de mensajes
        if (mensaje) { mensaje.textContent = ''; }
      } else {
        mensaje.textContent = "❌ Error al enviar. Revisa los campos.";
        mensaje.style.color = "red";
      }
    });
  </script>
    <!-- Flash overlay helper (se usa para mostrar confirmación tipo videojuego) -->
    <script>
      function showFlash(message, duration = 2500) {
        let overlay = document.getElementById('flash-overlay');
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.id = 'flash-overlay';
          document.body.appendChild(overlay);
        }
        overlay.innerText = message;
        overlay.classList.add('show');
        // accesibilidad
        overlay.setAttribute('role', 'status');
        overlay.setAttribute('aria-live', 'polite');
        // quitar tras duration
        clearTimeout(overlay._hideTimeout);
        overlay._hideTimeout = setTimeout(() => overlay.classList.remove('show'), duration);
      }
    </script>
  <!-- Google Places Autocomplete: populate lat/lng on selection (biased/restricted to Medellín) -->
  <script type="application/json" id="__seccion4_config">{{ {'GOOGLE_PLACES_API_KEY': config.get('GOOGLE_PLACES_API_KEY','')} | tojson }}</script>
  <script>
  (function(){
    // Medellín bounding box (approx.) to bias and restrict suggestions
    const MEDELLIN_BOUNDS = {
      sw: { lat: 6.09, lng: -75.66 },
      ne: { lat: 6.35, lng: -75.45 }
    };

    function initAutocomplete(){
      try{
        const addressInput = document.querySelector('input[name="direccion"]');
        const latInput = document.querySelector('input[name="latitud"]');
        const lngInput = document.querySelector('input[name="longitud"]');
        if(!addressInput) return;

        // construct LatLngBounds for Medellín
        const sw = new google.maps.LatLng(MEDELLIN_BOUNDS.sw.lat, MEDELLIN_BOUNDS.sw.lng);
        const ne = new google.maps.LatLng(MEDELLIN_BOUNDS.ne.lat, MEDELLIN_BOUNDS.ne.lng);
        const medBounds = new google.maps.LatLngBounds(sw, ne);

        const opts = {
          types: ['geocode'],
          bounds: medBounds,
          strictBounds: true,
          componentRestrictions: { country: 'co' }
        };

        const autocomplete = new google.maps.places.Autocomplete(addressInput, opts);
        autocomplete.addListener('place_changed', function(){
          try{
            const place = autocomplete.getPlace();
            if(place && place.geometry && place.geometry.location){
              const lat = place.geometry.location.lat();
              const lng = place.geometry.location.lng();
              if(latInput) latInput.value = lat;
              if(lngInput) lngInput.value = lng;
              const srcF = document.querySelector('input[name="location_source"]'); if(srcF) srcF.value='client';
              const cF = document.querySelector('input[name="location_confidence"]'); if(cF) cF.value='0.95';
            }
          }catch(_e){ console.warn('seccion4 place_changed', _e); }
        });
      }catch(e){ console.warn('seccion4 autocomplete init', e); }
    }

    // dynamic loader for Google Maps script using config value
    try{
      const raw = document.getElementById('__seccion4_config');
      let cfg = {};
      try{ cfg = raw ? JSON.parse(raw.textContent || raw.innerText || '{}') : {}; }catch(e){ cfg = {}; }
      const key = cfg && cfg.GOOGLE_PLACES_API_KEY ? cfg.GOOGLE_PLACES_API_KEY : '';
      if(key){
        const s = document.createElement('script');
        s.src = 'https://maps.googleapis.com/maps/api/js?key=' + encodeURIComponent(key) + '&libraries=places';
        s.async = true; s.defer = true;
        s.onload = function(){
          try{ initAutocomplete(); }catch(e){ console.warn('initAutocomplete onload', e); }
        };
        document.head.appendChild(s);
      } else {
        // If no API key configured, we still try to init in case script is already present
        function waitForGoogle(){ if(window.google && google.maps && google.maps.places) initAutocomplete(); else setTimeout(waitForGoogle, 300); }
        waitForGoogle();
      }
    }catch(e){ console.warn('seccion4 google loader', e); }
  })();
  </script>
  {% endblock %}